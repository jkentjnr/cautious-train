name: Generate Documentation and Create PR
description: Generate documentation using Claude and create a pull request

inputs:
  job-key:
    description: 'Job key to identify the documentation task'
    required: true
  prompt:
    description: 'Prompt for documentation generation'
    required: true
  pat-token:
    description: 'Personal Access Token for GitHub'
    required: true
  anthropic_api_key:
    description: 'Anthropic API Key for Claude'
    required: true

runs:
  using: composite
  steps:
    - name: Generate Documentation with Claude
      shell: bash
      run: |
        # Escape the prompt for JSON
        ESCAPED_PROMPT=$(printf '%s' "$PROMPT" | jq -Rs .)

        RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ inputs.anthropic_api_key }}" \
          -H "anthropic-version: 2023-06-01" \
          -d "$(jq -n --arg prompt "$PROMPT" '{
            "model": "claude-sonnet-4-20250514",
            "max_tokens": 20000,
            "messages": [
              {
                "role": "user",
                "content": $prompt
              }
            ]
          }')")
        echo "Response received from Claude."

        echo "Claude Response:"
        echo "$RESPONSE"
        echo ""

        # Get documentation path
        documentation=$(jq -r --arg key "$PARAM_JOB_KEY" '.jobs[] | select(.key == $key) | .documentation' documentation.json)

        # Extract the text content
        DATA=$(echo "$RESPONSE" | jq -r '.content[0].text')

        # Simple approach: extract everything between ```json and ```
        JSON_CONTENT=$(echo "$DATA" | grep -A 1000 '```json' | grep -B 1000 '^```$' | head -n -1 | tail -n +2)

        # Write to temp file and test
        echo "$JSON_CONTENT" > temp.json

        if jq empty temp.json 2>/dev/null; then
            echo "✓ JSON extracted successfully"
            
            # Extract fields
            jq -r '.summary' temp.json > summary.txt
            jq -r '.file' temp.json | sed 's/\\n/\n/g' > "./.tmp/$documentation"
            
            echo "✓ Files created"
        else
            echo "✗ Failed to extract valid JSON"
            echo "Extracted content:"
            cat temp.json
        fi

        rm temp.json

        echo "----------------------------------------"
        echo "Summary:"
        cat summary.txt
        echo "----------------------------------------"
        echo ""
        echo "Documentation updated at ./.tmp/$documentation:"
        echo "----------------------------------------"
        cat "./.tmp/$documentation"
        echo "----------------------------------------"

      env:
        ANTHROPIC_API_KEY: ${{ inputs.anthropic_api_key }}
        PROMPT: ${{ inputs.prompt }}
        PARAM_JOB_KEY: ${{ inputs.job-key }}

    - name: Generate Pull Request in Documentation Repository
      shell: bash
      run: |
        TARGET_BRANCH=$(jq -r '.docs.branch' documentation.json)

        cd ./.tmp

        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Check if there are any changes to commit
        if git diff --quiet && git diff --staged --quiet; then
          echo "No changes detected. Documentation is already up to date."
          exit 0
        fi

        # Create a new branch
        BRANCH_NAME="update/${{ inputs.job-key }}-$(date +%s)"
        git checkout -b $BRANCH_NAME

        # Stage changes
        git add .

        # Check again after staging (in case git add didn't stage anything)
        if git diff --staged --quiet; then
          echo "No changes to commit after staging. Documentation is already up to date."
          exit 0
        fi

        # Commit changes
        COMMIT_MESSAGE="Update documentation for flow: ${{ env.PARAM_JOB_KEY }}"
        git commit -m "$COMMIT_MESSAGE"

        # Push branch
        git push origin $BRANCH_NAME

        # Create Pull Request using gh CLI
        gh auth login --with-token <<< ${{ inputs.pat-token }}
        gh pr create --title "$COMMIT_MESSAGE" --body "$(cat ../summary.txt)" --head $BRANCH_NAME --base $TARGET_BRANCH
      env:
        PAT_TOKEN: ${{ inputs.pat-token }}
        PARAM_JOB_KEY: ${{ inputs.job-key }}